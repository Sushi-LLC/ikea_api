# Парсер главной страницы IKEA через scrape.do

## Описание

`HomepageFetcher` получает главную страницу IKEA Poland через scrape.do API и извлекает:
- **Хиты продаж** - список SKU продуктов
- **Популярные категории** - список URL/ID категорий

## Использование

### Получение данных

```ruby
result = HomepageFetcher.fetch
# => {
#   bestseller_skus: ["50258323", "40503626", ...],
#   popular_category_ids: ["https://www.ikea.com/pl/pl/cat/...", ...]
# }
```

### Обновление статусов через Jobs

Jobs автоматически используют `HomepageFetcher`:

1. **ParseBestsellersJob** - обновляет `is_bestseller = true` для найденных продуктов
2. **ParsePopularCategoriesJob** - обновляет `is_popular = true` для найденных категорий

```ruby
# Запуск через админку или напрямую
ParseBestsellersJob.perform_later(limit: 100)
ParsePopularCategoriesJob.perform_later(limit: 50)
```

## Логика работы

### Хиты продаж

1. Получает HTML главной страницы через scrape.do
2. Ищет секцию "Хиты продаж" / "Bestsellers" / "Hity"
3. Извлекает SKU из:
   - `data-product-id` атрибутов
   - Ссылок `/p/{product-slug}-{sku}/`
   - JSON-LD данных
   - Скриптов с данными о продуктах

### Популярные категории

1. Получает HTML главной страницы через scrape.do
2. Извлекает URL категорий из ссылок `/cat/{slug}/` (приоритет)
3. Извлекает числовые ID из data-атрибутов (fallback)
4. Игнорирует UUID (они не находятся в БД по `ikea_id`)

## Поиск в БД

### Продукты

Jobs ищут продукты по:
- Точному совпадению SKU
- SKU с/без буквы "s" в начале
- Частичному совпадению (последние 8 цифр)
- Поиску в URL продукта

### Категории

Jobs ищут категории по:
- Точному совпадению `ikea_id`
- Поиску по URL (slug из ссылки)
- Поиску по части slug (последняя часть после дефиса)

## Настройка

API токен scrape.do настраивается через переменную окружения:

```bash
SCRAPE_DO_API_TOKEN=752d361f2e444064955c30f0dd3b93b896726e4944e
```

## Результаты

- **Категории**: успешно находятся и обновляются (10/10 в тесте)
- **Продукты**: находятся только если они уже есть в БД (после парсинга продуктов)

## Примечания

- Если продукт не найден в БД, его статус не обновляется (нужно сначала запустить `ParseProductsJob`)
- UUID категорий игнорируются, так как они не совпадают с `ikea_id` в БД
- Приоритет отдается URL из ссылок над UUID из data-атрибутов


<div class="container-fluid">
  <% if flash[:message] %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= flash[:message] %>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  <% end %>
  
  <% if flash[:error] %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <%= flash[:error] %>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3>Запуск задач парсинга</h3>
        </div>
        <div class="card-body">
          <%= form_tag start_task_parser_control_admin_index_path, method: :post, data: { turbo: false }, class: "parser-start-form" do %>
            <div class="form-group">
              <%= label_tag :task_type, "Тип задачи", class: "form-label" %>
              <%= select_tag :task_type, 
                  options_for_select([
                    ['Категории', 'categories'],
                    ['Продукты', 'products'],
                    ['Хиты продаж', 'bestsellers'],
                    ['Популярные категории', 'popular_categories'],
                    ['Картинки категорий', 'category_images'],
                    ['Картинки продуктов', 'product_images']
                  ]),
                  { prompt: 'Выберите тип задачи', class: "form-control", required: true } %>
            </div>
            
            <div class="form-group">
              <%= label_tag :limit, "Лимит записей (необязательно)", class: "form-label" %>
              <%= number_field_tag :limit, nil, class: "form-control", placeholder: "Оставьте пустым для без ограничений", min: 1 %>
            </div>
            
            <%= submit_tag "Запустить", class: "btn btn-primary", data: { disable_with: "Запускается..." } %>
          <% end %>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3>Активные задачи <span class="badge badge-info" id="tasks-count"><%= @running_tasks.count %></span></h3>
        </div>
        <div class="card-body" id="active-tasks-container">
          <% if @running_tasks.any? %>
            <table class="table">
              <thead>
                <tr>
                  <th>Тип</th>
                  <th>Обработано</th>
                  <th>Действие</th>
                </tr>
              </thead>
              <tbody id="active-tasks-tbody">
                <% @running_tasks.each do |task| %>
                  <tr data-task-id="<%= task.id %>">
                    <td>
                      <%= {
                        'categories' => 'Категории',
                        'products' => 'Продукты',
                        'bestsellers' => 'Хиты продаж',
                        'popular_categories' => 'Популярные категории',
                        'category_images' => 'Картинки категорий',
                        'product_images' => 'Картинки продуктов'
                      }[task.task_type] || task.task_type %>
                      <% if task.status == 'pending' %>
                        <span class="badge badge-secondary ml-2">Ожидание</span>
                      <% elsif task.status == 'running' %>
                        <span class="badge badge-primary ml-2">Выполняется</span>
                      <% end %>
                    </td>
                    <td><%= task.processed %> / <%= task.limit || '∞' %></td>
                    <td>
                      <%= form_tag stop_task_parser_control_admin_index_path, method: :post, data: { turbo: false }, style: "display: inline;" do %>
                        <%= hidden_field_tag :task_id, task.id %>
                        <%= submit_tag "Остановить", class: "btn btn-sm btn-danger", data: { disable_with: "Останавливается...", confirm: "Вы уверены, что хотите остановить эту задачу?" } %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p class="text-muted" id="no-tasks-message">Нет активных задач</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3>Последние задачи</h3>
        </div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th>Тип</th>
                <th>Статус</th>
                <th>Обработано</th>
                <th>Создано</th>
                <th>Обновлено</th>
                <th>Ошибок</th>
                <th>Начало</th>
                <th>Завершено</th>
              </tr>
            </thead>
            <tbody>
              <% @recent_tasks.each do |task| %>
                <tr>
                  <td><%= task.task_type %></td>
                  <td>
                    <span class="badge badge-<%= task.status == 'completed' ? 'success' : task.status == 'failed' ? 'danger' : 'primary' %>">
                      <%= task.status %>
                    </span>
                  </td>
                  <td><%= task.processed %></td>
                  <td><%= task.created %></td>
                  <td><%= task.updated %></td>
                  <td><%= task.error_count %></td>
                  <td><%= task.started_at&.strftime('%d.%m.%Y %H:%M') %></td>
                  <td><%= task.completed_at&.strftime('%d.%m.%Y %H:%M') %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  // Переменная для хранения интервала обновления
  let updateInterval = null;
  let consecutiveEmptyUpdates = 0; // Счетчик пустых обновлений
  let currentUpdateInterval = 2000; // Текущий интервал обновления в миллисекундах
  
  // Функция для экранирования HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Функция для обновления списка активных задач
  function updateActiveTasks() {
    const container = document.getElementById('active-tasks-container');
    
    // Если контейнер не найден, значит мы не на этой странице - останавливаем обновление
    if (!container) {
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }
      return;
    }
    
    fetch('<%= active_tasks_parser_control_admin_index_path %>', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      // Повторно проверяем существование элементов (на случай навигации во время запроса)
      const container = document.getElementById('active-tasks-container');
      if (!container) {
        if (updateInterval) {
          clearInterval(updateInterval);
          updateInterval = null;
        }
        return;
      }
      
      const tbody = document.getElementById('active-tasks-tbody');
      const noTasksMessage = document.getElementById('no-tasks-message');
      const tasksCount = document.getElementById('tasks-count');
      
      // Обновляем счетчик
      if (tasksCount) {
        tasksCount.textContent = data.tasks.length;
      }
      
      // Если нет активных задач, увеличиваем счетчик пустых обновлений
      if (data.tasks.length === 0) {
        consecutiveEmptyUpdates++;
      } else {
        consecutiveEmptyUpdates = 0; // Сбрасываем счетчик, если есть задачи
      }
      
      if (data.tasks.length === 0) {
        // Нет активных задач
        if (tbody) {
          tbody.innerHTML = '';
        }
        if (!noTasksMessage) {
          const p = document.createElement('p');
          p.className = 'text-muted';
          p.id = 'no-tasks-message';
          p.textContent = 'Нет активных задач';
          container.innerHTML = '';
          container.appendChild(p);
        }
      } else {
        // Есть активные задачи
        if (noTasksMessage) {
          noTasksMessage.remove();
        }
        
        // Создаем таблицу, если её нет
        if (!tbody) {
          const table = document.createElement('table');
          table.className = 'table';
          table.innerHTML = `
            <thead>
              <tr>
                <th>Тип</th>
                <th>Обработано</th>
                <th>Действие</th>
              </tr>
            </thead>
            <tbody id="active-tasks-tbody"></tbody>
          `;
          container.innerHTML = '';
          container.appendChild(table);
        }
        
        const newTbody = document.getElementById('active-tasks-tbody');
        newTbody.innerHTML = '';
        
        // Добавляем задачи
        data.tasks.forEach(function(task) {
          const row = document.createElement('tr');
          row.setAttribute('data-task-id', task.id);
          
          const taskTypeLabel = {
            'categories': 'Категории',
            'products': 'Продукты',
            'bestsellers': 'Хиты продаж',
            'popular_categories': 'Популярные категории',
            'category_images': 'Картинки категорий',
            'product_images': 'Картинки продуктов'
          }[task.task_type] || task.task_type;
          
          const limitText = task.limit ? task.limit : '∞';
          const statusBadge = task.status === 'pending' 
            ? '<span class="badge badge-secondary ml-2">Ожидание</span>'
            : task.status === 'running'
            ? '<span class="badge badge-primary ml-2">Выполняется</span>'
            : '';
          
          // Получаем authenticity_token из мета-тега или формы
          const authToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                          document.querySelector('input[name="authenticity_token"]')?.value || '';
          
          row.innerHTML = `
            <td>${escapeHtml(taskTypeLabel)}${statusBadge}</td>
            <td>${task.processed} / ${limitText}</td>
            <td>
              <form action="<%= stop_task_parser_control_admin_index_path %>" method="post" style="display: inline;" data-turbo="false">
                <input type="hidden" name="authenticity_token" value="${authToken}">
                <input type="hidden" name="task_id" value="${task.id}">
                <input type="submit" value="Остановить" class="btn btn-sm btn-danger" 
                       data-disable-with="Останавливается..." 
                       data-confirm="Вы уверены, что хотите остановить эту задачу?">
              </form>
            </td>
          `;
          
          newTbody.appendChild(row);
        });
      }
      
      // Оптимизация: если нет активных задач долгое время, увеличиваем интервал
      // Если нет задач более 10 раз подряд (20 секунд при интервале 2 сек), останавливаем обновление
      // Если нет задач более 3 раз подряд (6 секунд), увеличиваем интервал до 10 секунд
      let newInterval = null;
      
      if (consecutiveEmptyUpdates > 10) {
        // Останавливаем обновление, если долго нет задач
        newInterval = null;
      } else if (consecutiveEmptyUpdates > 3) {
        // Увеличиваем интервал до 10 секунд, если нет задач
        newInterval = 10000;
      } else {
        // Возвращаем быстрый интервал (2 секунды)
        newInterval = 2000;
      }
      
      // Пересоздаем интервал только если он изменился
      if (newInterval !== currentUpdateInterval) {
        if (updateInterval) {
          clearInterval(updateInterval);
          updateInterval = null;
        }
        currentUpdateInterval = newInterval;
        if (newInterval !== null) {
          updateInterval = setInterval(updateActiveTasks, newInterval);
        }
      }
    })
    .catch(error => {
      console.error('Ошибка при обновлении списка задач:', error);
    });
  }
  
  // Функция для запуска обновления
  function startUpdating() {
    // Останавливаем предыдущий интервал, если он есть
    if (updateInterval) {
      clearInterval(updateInterval);
      updateInterval = null;
    }
    
    // Сбрасываем счетчик пустых обновлений и интервал
    consecutiveEmptyUpdates = 0;
    currentUpdateInterval = 2000;
    
    // Проверяем, что мы на нужной странице
    const container = document.getElementById('active-tasks-container');
    if (!container) {
      return;
    }
    
    // Обновляем сразу
    updateActiveTasks();
    
    // Запускаем интервал (начинаем с быстрого обновления)
    updateInterval = setInterval(updateActiveTasks, currentUpdateInterval);
  }
  
  // Запускаем обновление при загрузке страницы
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startUpdating);
  } else {
    startUpdating();
  }
  
  // Останавливаем обновление при уходе со страницы
  window.addEventListener('beforeunload', function() {
    if (updateInterval) {
      clearInterval(updateInterval);
      updateInterval = null;
    }
  });
  
  // Останавливаем обновление при навигации через Turbo/Trestle
  document.addEventListener('turbo:before-visit', function() {
    if (updateInterval) {
      clearInterval(updateInterval);
      updateInterval = null;
    }
  });
  
  // Перезапускаем обновление после навигации (если вернулись на эту страницу)
  document.addEventListener('turbo:load', function() {
    const container = document.getElementById('active-tasks-container');
    if (container && !updateInterval) {
      startUpdating();
    }
  });
  
  // Обновляем список после отправки формы запуска задачи
  const startForm = document.querySelector('.parser-start-form');
  if (startForm) {
    startForm.addEventListener('submit', function() {
      // Сбрасываем счетчик пустых обновлений при запуске новой задачи
      consecutiveEmptyUpdates = 0;
      currentUpdateInterval = 1000; // Быстрое обновление при запуске задачи
      
      // Обновляем через небольшую задержку после отправки формы
      setTimeout(function() {
        const container = document.getElementById('active-tasks-container');
        if (!container) {
          return;
        }
        
        updateActiveTasks();
        // Увеличиваем частоту обновления после запуска задачи (1 секунда)
        if (updateInterval) {
          clearInterval(updateInterval);
        }
        updateInterval = setInterval(updateActiveTasks, currentUpdateInterval);
      }, 500);
    });
  }
})();
</script>


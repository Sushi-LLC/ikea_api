# Конфигурация Nginx для IKEA API и Frontend
# Разместить в /etc/nginx/sites-available/ikea_api

# Upstream для Rails API через Puma (Unix socket)
upstream ikea_api_backend {
    server unix:/home/deploy/apps/ikea_back/shared/tmp/sockets/puma.sock fail_timeout=0;
    keepalive 64;
}

# Upstream для фронтенда (Next.js) уже определен в ikea-parser.conf
# Используем существующий upstream ikea_front

# Основной сервер
server {
    listen 80;
    server_name 45.135.234.22 _;  # Временно IP, позже замените на домен
    # Используем _ для обработки всех запросов, но приоритет ниже чем у конкретных server_name

    # Логи
    access_log /var/log/nginx/ikea_api_access.log;
    error_log /var/log/nginx/ikea_api_error.log;

    # Максимальный размер загружаемых файлов
    client_max_body_size 100M;

    # API endpoints - проксирование к Rails приложению
    location /api {
        proxy_pass http://ikea_api_backend;
        proxy_http_version 1.1;
        
        # Заголовки
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Отключение буферизации для streaming
        proxy_buffering off;
        
        # CORS заголовки (если нужно)
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
        
        # Обработка OPTIONS запросов
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    # Health check endpoint
    location /up {
        proxy_pass http://ikea_api_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;
    }

    # Swagger документация
    location /api-docs {
        proxy_pass http://ikea_api_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Статические файлы (ассеты)
    # ВАЖНО: более специфичные location должны быть ПЕРЕД общими
    # Порядок важен: сначала Next.js assets, потом Rails assets
    
    # Next.js assets (CSS, JS, images) - проксируем к Next.js
    # Next.js генерирует пути без префикса /ikea_front/
    location ~ ^/assets/(css|js|img)/ {
        proxy_pass http://ikea_front;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, max-age=3600";
    }

    # Rails ассеты (Trestle и другие) - обслуживаем напрямую из public/assets
    location /assets {
        alias /home/deploy/apps/ikea_back/current/public/assets;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # Попытка найти файл, если не найден - возвращаем 404
        try_files $uri =404;
    }

    # Изображения продуктов и категорий - обслуживаем из public/images
    location /images {
        alias /home/deploy/apps/ikea_back/current/public/images;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        access_log off;
        
        # Попытка найти файл, если не найден - возвращаем 404
        try_files $uri =404;
    }

    # Next.js статические файлы без префикса (для запросов из /ikea_front/)
    # Next.js генерирует пути без префикса, поэтому нужно обработать их отдельно
    location /_next/ {
        proxy_pass http://ikea_front;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, immutable";
    }

    # Trestle Admin Panel
    location /admin {
        proxy_pass http://ikea_api_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Frontend (Next.js) - статические файлы _next
    location /ikea_front/_next/ {
        rewrite ^/ikea_front/_next/(.*) /_next/$1 break;
        proxy_pass http://ikea_front;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, immutable";
    }

    # Frontend (Next.js) - статические файлы assets
    location /ikea_front/assets/ {
        rewrite ^/ikea_front/assets/(.*) /assets/$1 break;
        proxy_pass http://ikea_front;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, max-age=3600";
    }

    # Frontend (Next.js) - основной location
    location /ikea_front/ {
        rewrite ^/ikea_front/(.*) /$1 break;
        proxy_pass http://ikea_front;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Редирект с /ikea_front на /ikea_front/
    location = /ikea_front {
        return 301 /ikea_front/;
    }

    # Обработка запросов Next.js без префикса (для RSC и других маршрутов)
    # Next.js может делать запросы к маршрутам без префикса /ikea_front/
    # Проксируем их к Next.js, но только если это не известные Rails маршруты
    # Используем более широкий паттерн для обработки всех Next.js маршрутов
    location ~ ^/(services|favorites|cart|catalog|profile|login|register|product|category|delivery|payment|pickup|cooperation|_rsc|_next/data) {
        proxy_pass http://ikea_front;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Favicon для Next.js
    location = /favicon.ico {
        proxy_pass http://ikea_front;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Блокировка доступа к скрытым файлам
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# Конфигурация для HTTPS (когда добавите домен)
# Раскомментируйте после настройки SSL
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com www.your-domain.com;
# 
#     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
# 
#     # Остальная конфигурация аналогична HTTP серверу
#     # ...
# }
# 
# # Редирект с HTTP на HTTPS
# server {
#     listen 80;
#     server_name your-domain.com www.your-domain.com;
#     return 301 https://$server_name$request_uri;
# }



#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ upstream ikea_front

set -e

SERVER="deploy@45.135.234.22"
CONFIG_FILE="/etc/nginx/sites-available/ikea-parser"

echo "üìã –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."

ssh "$SERVER" << 'EOF'
# –î–æ–±–∞–≤–ª—è–µ–º upstream –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è ikea_parser_api
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥ - –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–∏ ikea_parser_api
sudo bash -c 'cat >> /tmp/ikea_front_upstream.txt << UPSTREAMEOF

# Upstream –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
upstream ikea_front {
  server localhost:3000;
  keepalive 64;
}
UPSTREAMEOF
'

# –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–æ–π ikea_parser_api –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –Ω–µ—ë
sudo awk '/^upstream ikea_parser_api {/,/^}/ {print; if (/^}/) {while ((getline line < "/tmp/ikea_front_upstream.txt") > 0) print line; close("/tmp/ikea_front_upstream.txt")}; next} 1' /etc/nginx/sites-available/ikea-parser > /tmp/ikea-parser-new.conf
sudo mv /tmp/ikea-parser-new.conf /etc/nginx/sites-available/ikea-parser
sudo rm -f /tmp/ikea_front_upstream.txt

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
sudo nginx -t

if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞"
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx..."
    sudo systemctl reload nginx
    echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx!"
    exit 1
fi
EOF

echo ""
echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!"

